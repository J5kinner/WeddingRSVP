name: CI
on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

  jobs:
    ci:
      name: Lint • Typecheck • Build
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: 20
            cache: 'pnpm'

        - name: Setup pnpm
          uses: pnpm/action-setup@v4
          with:
            version: 9

        - name: Install deps
          run: pnpm install --frozen-lockfile

        # Prisma sanity
        - name: Prisma format + generate + validate
          run: |
            npx prisma format
            npx prisma generate
            npx prisma validate

        - name: Lint
          run: pnpm eslint . --max-warnings=0

        - name: Typecheck
          run: pnpm tsc --noEmit

        # Build check only (no start)
        - name: Next.js build
          env:
            # Provide minimal env so build can succeed even without prod secrets
            NEXT_PUBLIC_SITE_URL: http://localhost:3000
            # Prisma needs DATABASE_URL for generate, but can use dummy value for build
            DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          run: pnpm next build
